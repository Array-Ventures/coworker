#!/usr/bin/env bun
/**
 * msg â€” Send messages through connected channels (WhatsApp, etc.)
 *
 * Usage:
 *   msg send --channel whatsapp --to "+1234567890" "Hello!"
 *   msg send --channel whatsapp --to "120363001234@g.us" "Group message"
 *   msg send --channel whatsapp --to "+123" --image /path/to/photo.jpg "Check this out"
 *   msg send --channel whatsapp --to "+123" --file /path/to/report.pdf
 *   msg send --channel whatsapp --to "+123" --audio /path/to/voice.ogg --ptt
 *   msg channels
 *   msg groups
 */

import { readFileSync } from 'node:fs';
import { basename, extname } from 'node:path';

const BASE = process.env.COWORKER_URL || `http://localhost:${process.env.PORT || 4111}`;

async function api(method: string, path: string, body?: unknown) {
  const res = await fetch(`${BASE}${path}`, {
    method,
    headers: body ? { 'Content-Type': 'application/json' } : undefined,
    body: body ? JSON.stringify(body) : undefined,
  });
  const data = await res.json();
  console.log(JSON.stringify(data, null, 2));
  if (!res.ok) process.exit(1);
}

const args = process.argv.slice(2);
const command = args[0];

function flag(name: string): string | undefined {
  const idx = args.indexOf(`--${name}`);
  return idx !== -1 && idx + 1 < args.length ? args[idx + 1] : undefined;
}

function hasFlag(name: string): boolean {
  return args.includes(`--${name}`);
}

/** Guess MIME type from file extension */
function guessMime(filePath: string): string {
  const ext = extname(filePath).toLowerCase();
  const map: Record<string, string> = {
    '.jpg': 'image/jpeg', '.jpeg': 'image/jpeg', '.png': 'image/png', '.gif': 'image/gif', '.webp': 'image/webp',
    '.mp4': 'video/mp4', '.mov': 'video/quicktime', '.avi': 'video/x-msvideo',
    '.ogg': 'audio/ogg', '.mp3': 'audio/mpeg', '.m4a': 'audio/mp4', '.wav': 'audio/wav', '.opus': 'audio/opus',
    '.pdf': 'application/pdf', '.doc': 'application/msword', '.docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    '.xls': 'application/vnd.ms-excel', '.xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    '.zip': 'application/zip', '.txt': 'text/plain',
  };
  return map[ext] || 'application/octet-stream';
}

/** Read a file and return base64-encoded data */
function readFileAsBase64(filePath: string): string {
  const buf = readFileSync(filePath);
  return buf.toString('base64');
}

switch (command) {
  case 'send': {
    const channel = flag('channel');
    const to = flag('to');
    const replyTo = flag('reply-to');

    // Media flags
    const imagePath = flag('image');
    const filePath = flag('file');
    const audioPath = flag('audio');
    const videoPath = flag('video');
    const stickerPath = flag('sticker');
    const ptt = hasFlag('ptt');

    // Last positional arg that isn't a flag value is the message text
    const mediaFlags = new Set(['--image', '--file', '--audio', '--video', '--sticker']);
    const text = args.filter((a, i) => {
      if (a.startsWith('--')) return false;
      if (i > 0 && args[i - 1]?.startsWith('--')) return false;
      if (i === 0) return false; // skip 'send'
      return true;
    }).join(' ');

    if (!channel || !to || (!text && !imagePath && !filePath && !audioPath && !videoPath && !stickerPath)) {
      console.error('Usage: msg send --channel <ch> --to <recipient> [--image|--file|--audio|--video|--sticker path] [--ptt] "message"');
      process.exit(1);
    }

    const media: any[] = [];

    if (imagePath) {
      media.push({ type: 'image', data: readFileAsBase64(imagePath), mimeType: guessMime(imagePath), caption: text || undefined });
    }
    if (filePath) {
      media.push({ type: 'document', data: readFileAsBase64(filePath), mimeType: guessMime(filePath), fileName: basename(filePath), caption: text || undefined });
    }
    if (audioPath) {
      media.push({ type: 'audio', data: readFileAsBase64(audioPath), mimeType: guessMime(audioPath), ptt });
    }
    if (videoPath) {
      media.push({ type: 'video', data: readFileAsBase64(videoPath), mimeType: guessMime(videoPath), caption: text || undefined });
    }
    if (stickerPath) {
      media.push({ type: 'sticker', data: readFileAsBase64(stickerPath), mimeType: guessMime(stickerPath) });
    }

    // If media has caption, don't send text separately
    const sendText = media.length > 0 && (imagePath || filePath || videoPath) ? '' : text;

    await api('POST', '/messaging/send', {
      channel, to, text: sendText, replyTo,
      ...(media.length > 0 ? { media } : {}),
    });
    break;
  }
  case 'channels':
    await api('GET', '/messaging/channels');
    break;
  case 'groups':
    await api('GET', '/messaging/groups');
    break;
  default:
    console.error('Usage: msg <send|channels|groups>');
    process.exit(1);
}
